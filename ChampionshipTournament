from tournament import *
import math
import string
import random
import itertools


class ChampionshipTournament(Tournament):
    def __init__(self, strategies):
        super().__init__(strategies, "ChampionshipTournament")
        self.playoffs = []
        # ×× ×™ ×œ× ×××© ×™×•×“×¢×ª ××™×š ×¢×•×‘×“×™× ×”×‘×ª×™× ××‘×œ ×××” ×©×”×‘× ×ª×™ ×œ×¨×•×‘ ×™×© 4 ×§×‘×•×¦×•×ª ×‘×‘×™×ª
        if len(strategies) <= 16:
            number_of_groups = math.ceil(len(strategies) / 4)
        else:
            number_of_groups = 8

        # ××¢×¨×‘×‘×™× ××ª ×¨×©×™××ª ×”××¡×˜×¨×˜×’×™×•×ª
        shuffled = strategies[:]  # ×¢×•×©×™× ×¢×•×ª×§ ×›×“×™ ×œ× ×œ×”×¨×•×¡ ××ª ×”×¨×©×™××” ×”××§×•×¨×™×ª
        random.shuffle(shuffled)

        # ×™×•×¦×¨×™× ××™×œ×•×Ÿ ×©×œ ×‘×ª×™×
        self.groups = {string.ascii_uppercase[i]: [] for i in range(number_of_groups)}

        # ××—×œ×§×™× ××ª ×”××¡×˜×¨×˜×’×™×•×ª ×œ×‘×ª×™× ×œ×¤×™ ×¡×‘×‘
        group_names = list(self.groups.keys())
        for i, s in enumerate(shuffled):
            group = group_names[i % number_of_groups]
            self.groups[group].append(s)

        self.group_results = {}  # ××™×œ×•×Ÿ ×—×“×© ×‘××—×œ×§×”

    def internal_league(self, group):
        """×œ×™×’×” ×¤× ×™××™×ª. ×‘×›×œ ×‘×™×ª ×›×œ ×”×§×‘×•×¦×•×ª ×™×©×—×§×• ××—×ª ××•×œ ×”×©× ×™×™×”, ×›××©×¨ × ×¡×¤×•×¨ ×œ×›×œ ××—×ª ×›××•×ª × ×™×¦×—×•× ×•×ª"""
        scores = {team: 0 for team in group}
        for a, b in itertools.combinations(group, 2):
            winner, desc = super().run(a, b)
            print(desc)  # ××“×¤×™×¡×™× ××ª ×”×ª×™××•×¨ ×©×œ ×”××©×—×§
            scores[winner] += 1  # ××¢×“×›× ×™× × ×™×¦×—×•×Ÿ
        return scores

    def group_stage(self, groups):
        winners = []
        self.group_results = {}
        for name, group in groups.items():
            print(f"\n--- ×‘×™×ª {name} ---")
            scores = self.internal_league(group)
            winner = max(scores, key=scores.get)
            print(f"×‘×™×ª {name} â€“ ×× ×¦×—×ª: {winner}, ×˜×‘×œ×”: {scores}")
            winners.append(winner)
            self.group_results[name] = {
                "scores": scores,
                "winner": winner
            }
        return winners

    def playoff(self, teams):
        """××¨×™×¥ ×¤×œ×™×™××•×£ ×¢×“ ×©× ×©××¨×ª ×× ×¦×—×ª ×•×©×•××¨ ××ª ×¨×©×™××ª ×”××©×—×§×™×"""
        round_num = 1
        current = teams
        while len(current) > 1:
            print(f"\n×¤×œ×™×™××•×£ â€“ ×¡×™×‘×•×‘ {round_num}")
            winners = []
            for i in range(0, len(current), 2):
                if i + 1 >= len(current):
                    winners.append(current[i])  # ×¢×•×œ×” ××•×˜×•××˜×™×ª
                    # ×©×•××¨×™× ×‘××©×—×§×™× ×’× "×¢×œ×™×™×” ××•×˜×•××˜×™×ª"
                    self.playoffs.append({
                        "round": round_num,
                        "team1": current[i],
                        "team2": None,
                        "winner": current[i],
                        "desc": f"{current[i]} ×¢×œ×ª×” ××•×˜×•××˜×™×ª"
                    })
                    continue

                a, b = current[i], current[i + 1]
                winner, desc = super().run(a, b)
                print(desc)
                winners.append(winner)

                # ×©×•××¨×™× ××ª ×”××©×—×§ ×‘×¨×©×™××ª ×”×¤×œ×™×™××•×£
                self.playoffs.append({
                    "round": round_num,
                    "team1": a,
                    "team2": b,
                    "winner": winner,
                    "desc": desc
                })

            current = winners
            round_num += 1

        return current[0]

    def print_groups(self):
        print("\n=== ×˜×‘×œ×ª ×‘×ª×™× ===")
        for name, data in self.group_results.items():
            print(f"\n×‘×™×ª {name}:")
            for team, score in data["scores"].items():
                print(f"  {team}: {score} × ×™×¦×—×•× ×•×ª")
            print(f"â†’ ×× ×¦×—×ª ×”×‘×™×ª: {data['winner']}")

    def print_playoffs(self):
        print("\n=== ×¢×¥ ×”×¤×œ×™×™××•×£ ===")
        for game in self.playoffs:
            rnd = game["round"]
            t1 = game["team1"]
            t2 = game["team2"] if game["team2"] else "â€”"
            w = game["winner"]
            print(f"×¡×™×‘×•×‘ {rnd}: {t1} vs {t2} â†’ ×× ×¦×—×ª: {w}")

    def run(self, a=None, b=None):
        if a is not None and b is not None:
            return super().run(a, b)

        winners = self.group_stage(self.groups)
        champion = self.playoff(winners)

        print("\n=== ×¡×™×›×•× ===")
        self.print_groups()
        self.print_playoffs()
        print(f"\nğŸ† ×”××œ×•×¤×”: {champion}")
        return champion
